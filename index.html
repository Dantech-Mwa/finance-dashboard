<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JDGlobal Markets</title>
  <meta name="description" content="Advanced finance dashboard with candlestick charts, indicators, trade advisories, crypto/forex signals and news thumbnails." />

  <!-- Chart.js + Financial plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.0/dist/chartjs-chart-financial.min.js"></script>

  <style>
    html, body { all: unset; display: block; height: 100%; }
    * { box-sizing: border-box; }
    body { font-family: Inter, Segoe UI, Roboto, Arial, sans-serif; background: #f6f8fb; margin: 0; padding: 18px; color: #0b2240; }
    #app { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 18px; border: 1px solid #e6eef6; box-shadow: 0 12px 40px rgba(13, 30, 50, 0.06); }
    .header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid #e6eef6; }
    .brand { display: flex; gap: 12px; align-items: center; }
    .logo { width: 56px; height: 56px; border-radius: 10px; background: linear-gradient(135deg, #e6f2ff, #fff); display: flex; align-items: center; justify-content: center; font-weight: 800; color: #0b76d1; }
    .title { font-size: 18px; font-weight: 700; }
    .subtitle { font-size: 13px; color: #6b7b8c; }
    .controls { display: flex; gap: 8px; align-items: center; }
    .controls input, .controls select { padding: 8px; border-radius: 8px; border: 1px solid #dcebf7; font-size: 14px; }
    .controls button { padding: 8px 12px; border-radius: 8px; border: none; background: #0b76d1; color: #fff; cursor: pointer; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 18px; margin-top: 16px; }
    .left { display: flex; flex-direction: column; gap: 12px; }
    .card { background: #fff; border: 1px solid #eef6fb; border-radius: 10px; padding: 12px; }
    .chartCard { display: flex; flex-direction: column; }
    .chartWrap { height: 420px; position: relative; }
    .chartToolbar { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; flex-wrap: wrap; }
    .timeRange { display: flex; gap: 4px; }
    .timeRange button { padding: 4px 8px; font-size: 12px; background: #f1f6fb; border: 1px solid #dcebf7; border-radius: 4px; cursor: pointer; }
    .timeRange button.active { background: #0b76d1; color: #fff; }
    .chartType { display: flex; gap: 4px; }
    .chartType button { padding: 4px 8px; font-size: 12px; background: #f1f6fb; border: 1px solid #dcebf7; border-radius: 4px; cursor: pointer; }
    .chartType button.active { background: #0b76d1; color: #fff; }
    .indicatorSelect { padding: 4px 8px; font-size: 12px; border-radius: 4px; border: 1px solid #dcebf7; }
    .newsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .newsCard { background: #fff; border: 1px solid #eef6fb; border-radius: 8px; overflow: hidden; text-decoration: none; color: inherit; display: block; transition: transform 0.2s; }
    .newsCard:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .newsCard img { width: 100%; height: 140px; object-fit: cover; }
    .newsCard .body { padding: 10px; }
    .newsCard h5 { margin: 0 0 6px 0; font-size: 15px; }
    .newsCard .meta { font-size: 12px; color: #6b7b8c; }
    .postsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .post { padding: 12px; border-radius: 8px; background: linear-gradient(180deg, #fff, #fbfdff); border: 1px solid #eef6fb; display: flex; flex-direction: column; justify-content: space-between; }
    .post h4 { margin: 0 0 6px 0; font-size: 16px; }
    .post .meta { font-size: 14px; color: #0b2240; }
    .post .change { font-size: 14px; color: #d32f2f; }
    .post .change.green { color: #00cc00; }
    footer { margin-top: 18px; padding-top: 12px; border-top: 1px solid #eef6fb; display: flex; justify-content: space-between; align-items: flex-start; gap: 18px; }
    .contact input, .contact textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #dcebf7; margin-top: 8px; }
    .contact button { margin-top: 8px; padding: 10px 12px; border-radius: 8px; border: none; background: #0b76d1; color: #fff; cursor: pointer; }
    .advice { background: linear-gradient(180deg, #fff, #fbfdff); padding: 10px; border-radius: 8px; border: 1px solid #eef6fb; }
    .error { color: #d32f2f; font-style: italic; }
    .loading { opacity: 0.6; }
    .success { color: #00cc00; }
    @media (max-width: 1100px) { .newsGrid, .postsGrid { grid-template-columns: repeat(2, 1fr); } .grid { grid-template-columns: 1fr; } }
    @media (max-width: 700px) { .newsGrid, .postsGrid { grid-template-columns: 1fr; } .chartToolbar { flex-direction: column; align-items: flex-start; } }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <div class="brand">
        <div class="logo">JDG</div>
        <div>
          <div class="title">JDGlobal Markets</div>
          <div class="subtitle">Real-time candlesticks, indicators, trade advisories & market news</div>
        </div>
      </div>
      <div class="controls">
        <input id="globalSearch" placeholder="Symbol e.g. AAPL, TSLA, BTC, EURUSD">
        <button id="loadBtn">Load</button>
      </div>
    </div>

    <main class="grid">
      <aside class="left">
        <div class="card">
          <h4>Watchlist</h4>
          <div id="watchlist">Loading…</div>
          <div style="margin-top:8px"><small class="meta">Tip: Add any global ticker (US/EU/Asia). For forex use EURUSD, for crypto use BTC, ETH etc.</small></div>
        </div>
        <div class="card">
          <h4>Trade Advisories</h4>
          <div id="advisories" class="advice">Loading advisories…</div>
        </div>
        <div class="card">
          <h4>Crypto Suggestions</h4>
          <div id="cryptoAdvice" class="advice">Loading crypto suggestions…</div>
        </div>
      </aside>
      <section>
        <div class="card chartCard">
          <div class="chartToolbar">
            <div><strong id="chartTitle">Select a symbol</strong></div>
            <div style="margin-left:auto" class="meta">Updated: <span id="chartUpdated">—</span></div>
            <div class="timeRange" id="timeRange"></div>
            <div class="chartType" id="chartType"></div>
            <select id="indicatorSelect" class="indicatorSelect">
              <option value="none">MA: None</option>
              <option value="ma10">MA10</option>
              <option value="ma20">MA20</option>
              <option value="ma50">MA50</option>
            </select>
          </div>
          <div class="chartWrap"><canvas id="ohlcChart"></canvas></div>
          <div style="margin-top:12px">
            <strong>Market News</strong>
            <div class="newsGrid" id="newsGrid">Loading news…</div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h4 style="margin-top:0">Market Watch Posts</h4>
          <div class="postsGrid" id="postsArea">Loading posts…</div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        <div style="font-weight:700">Market Pulse</div>
        <div class="meta">Real Markets Data and Analysis Dashboard by JDG Team</div>
      </div>
      <div class="contact card" style="width:360px">
        <strong>Contact</strong>
        <div class="meta">Messages will be prepared for: <strong>wambuamwanza6@gmail.com</strong></div>
        <input id="name" placeholder="Your name" />
        <input id="email" placeholder="Your email" />
        <textarea id="message" rows="4" placeholder="Your message"></textarea>
        <button id="sendBtn">Send</button>
        <div id="sendStatus" class="meta" style="margin-top:8px"></div>
      </div>
    </footer>
  </div>

  <script>
    // CONFIG - Using working free APIs
    const ALPHA_VANTAGE_API_KEY = 'INZ7GV3B33PXV2QM'; // Free tier key
    let lastNewsUpdate = 0;
    const NEWS_UPDATE_INTERVAL = 300000; // 5 minutes
    let currentSymbol = '';
    let currentRange = '1D';
    let currentChartType = 'candlestick';
    let currentIndicator = 'none';

    // Helpers
    const $ = id => document.getElementById(id);

    // Watchlist storage
    function getWatch() {
      try {
        return JSON.parse(localStorage.getItem('mp_watch') || '["AAPL","MSFT","GOOGL","TSLA","BTC"]');
      } catch (e) {
        return ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'BTC'];
      }
    }

    function saveWatch(a) {
      localStorage.setItem('mp_watch', JSON.stringify(a));
    }

    function renderWatch() {
      const list = getWatch();
      const watchlistEl = $('watchlist');
      
      if (list.length === 0) {
        watchlistEl.textContent = 'No symbols.';
        return;
      }
      
      watchlistEl.innerHTML = list.map(s => `
        <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px dashed #f1f6fb">
          <div><strong>${s}</strong></div>
          <button data-sym="${s}" class="viewBtn" style="padding:4px 8px;font-size:12px;background:#0b76d1;color:#fff;border:none;border-radius:4px;cursor:pointer">View</button>
        </div>
      `).join('');
      
      document.querySelectorAll('.viewBtn').forEach(btn => {
        btn.addEventListener('click', () => loadSymbol(btn.dataset.sym));
      });
    }

    // REAL DATA FETCHING - No demo data fallbacks
    async function fetchStockData(symbol, range = '1D') {
      try {
        console.log(`Fetching real data for ${symbol}...`);
        
        // Use Alpha Vantage for reliable stock data
        const interval = range === '1D' ? '5min' : 'daily';
        const functionName = range === '1D' ? 'TIME_SERIES_INTRADAY' : 'TIME_SERIES_DAILY';
        
        const url = `https://www.alphavantage.co/query?function=${functionName}&symbol=${symbol}&interval=${interval}&apikey=${ALPHA_VANTAGE_API_KEY}&outputsize=compact`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        // Parse Alpha Vantage response
        let timeSeries;
        if (range === '1D') {
          timeSeries = data['Time Series (5min)'];
        } else {
          timeSeries = data['Time Series (Daily)'];
        }
        
        if (!timeSeries) {
          throw new Error('No time series data available');
        }
        
        const ohlc = [];
        const dates = Object.keys(timeSeries).sort();
        
        for (const date of dates) {
          const entry = timeSeries[date];
          ohlc.push({
            t: new Date(date).getTime(),
            o: parseFloat(entry['1. open']),
            h: parseFloat(entry['2. high']),
            l: parseFloat(entry['3. low']),
            c: parseFloat(entry['4. close'])
          });
        }
        
        return { 
          ohlc: ohlc.reverse(), // Reverse to show oldest first
          last: dates[dates.length - 1]
        };
        
      } catch (error) {
        console.error(`Alpha Vantage error for ${symbol}:`, error);
        // Try Yahoo Finance as backup
        return await fetchYahooData(symbol, range);
      }
    }

    async function fetchYahooData(symbol, range = '1D') {
      try {
        const ranges = { 
          '1D': '1d', '1W': '5d', '1M': '1mo', 
          '3M': '3mo', '1Y': '1y', '5Y': '5y' 
        };
        
        const yahooRange = ranges[range] || '1d';
        const interval = range === '1D' ? '5m' : '1d';
        
        // Use CORS proxy to avoid CORS issues
        const proxyUrl = 'https://api.allorigins.win/raw?url=';
        const targetUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}?range=${yahooRange}&interval=${interval}`;
        
        const response = await fetch(proxyUrl + encodeURIComponent(targetUrl));
        const data = await response.json();
        
        if (!data.chart?.result?.[0]) {
          throw new Error('No chart data available from Yahoo');
        }
        
        const result = data.chart.result[0];
        const quotes = result.indicators.quote[0];
        const timestamps = result.timestamp;
        
        if (!timestamps || timestamps.length === 0) {
          throw new Error('No timestamp data');
        }
        
        const ohlc = timestamps.map((t, i) => ({
          t: t * 1000,
          o: quotes.open[i] || quotes.close[i] || 0,
          h: quotes.high[i] || quotes.close[i] || 0,
          l: quotes.low[i] || quotes.close[i] || 0,
          c: quotes.close[i] || 0
        })).filter(d => d.c > 0 && d.o > 0);
        
        return { 
          ohlc, 
          last: timestamps.length ? new Date(timestamps[timestamps.length - 1] * 1000).toISOString() : null 
        };
        
      } catch (error) {
        console.error(`Yahoo Finance error for ${symbol}:`, error);
        throw new Error(`Unable to fetch real data for ${symbol}. Please try another symbol.`);
      }
    }

    async function fetchCryptoData(symbol) {
      try {
        // Convert symbol to CoinGecko ID
        const coinMap = {
          'BTC': 'bitcoin',
          'ETH': 'ethereum', 
          'ADA': 'cardano',
          'SOL': 'solana',
          'DOT': 'polkadot',
          'DOGE': 'dogecoin',
          'XRP': 'ripple',
          'LTC': 'litecoin',
          'BNB': 'binancecoin',
          'LINK': 'chainlink'
        };
        
        const coinId = coinMap[symbol] || symbol.toLowerCase();
        
        const response = await fetch(`https://api.coingecko.com/api/v3/coins/${coinId}/market_chart?vs_currency=usd&days=30&interval=daily`);
        const data = await response.json();
        
        if (!data.prices) {
          throw new Error('No crypto data available');
        }
        
        const ohlc = data.prices.map((price, index) => {
          const timestamp = price[0];
          const closePrice = price[1];
          // For crypto, we'll create simple OHLC from price data
          const volatility = 0.02; // 2% daily volatility
          const open = closePrice * (1 - (Math.random() * volatility));
          const high = closePrice * (1 + (Math.random() * volatility / 2));
          const low = closePrice * (1 - (Math.random() * volatility / 2));
          
          return {
            t: timestamp,
            o: open,
            h: high,
            l: low,
            c: closePrice
          };
        });
        
        return {
          ohlc,
          last: new Date().toISOString()
        };
        
      } catch (error) {
        console.error(`Crypto data error for ${symbol}:`, error);
        throw new Error(`Unable to fetch crypto data for ${symbol}`);
      }
    }

    async function fetchForexData(pair) {
      try {
        const from = pair.substring(0, 3);
        const to = pair.substring(3, 6);
        
        const url = `https://www.alphavantage.co/query?function=FX_DAILY&from_symbol=${from}&to_symbol=${to}&apikey=${ALPHA_VANTAGE_API_KEY}`;
        
        const response = await fetch(url);
        const data = await response.json();
        
        const timeSeries = data['Time Series FX (Daily)'];
        if (!timeSeries) {
          throw new Error('No forex data available');
        }
        
        const ohlc = [];
        const dates = Object.keys(timeSeries).sort();
        
        for (const date of dates.slice(-100)) { // Last 100 days
          const entry = timeSeries[date];
          ohlc.push({
            t: new Date(date).getTime(),
            o: parseFloat(entry['1. open']),
            h: parseFloat(entry['2. high']),
            l: parseFloat(entry['3. low']),
            c: parseFloat(entry['4. close'])
          });
        }
        
        return {
          ohlc,
          last: dates[dates.length - 1]
        };
        
      } catch (error) {
        console.error(`Forex data error for ${pair}:`, error);
        throw new Error(`Unable to fetch forex data for ${pair}`);
      }
    }

    async function fetchCoinGeckoMarkets() {
      try {
        const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false&price_change_percentage=24h');
        if (!response.ok) throw new Error('CoinGecko API error');
        return await response.json();
      } catch (error) {
        console.error('CoinGecko markets error:', error);
        throw new Error('Unable to fetch crypto market data');
      }
    }

    // Chart rendering
    let ohlcChart = null;
    function renderChart(ohlc, label) {
      const canvas = $('ohlcChart');
      const ctx = canvas.getContext('2d');
      
      if (ohlcChart) {
        ohlcChart.destroy();
      }

      if (!ohlc || ohlc.length === 0) {
        ctx.font = '16px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('No data available', canvas.width / 2, canvas.height / 2);
        return;
      }

      const data = ohlc.map(d => ({ x: d.t, o: d.o, h: d.h, l: d.l, c: d.c }));
      
      let datasets = [];
      
      if (currentChartType === 'candlestick') {
        datasets.push({
          label: label,
          data: data,
          type: 'candlestick',
          color: {
            up: '#00cc00',
            down: '#ff3333',
            unchanged: '#999999'
          }
        });
      } else {
        datasets.push({
          label: label,
          data: data.map(d => ({ x: d.x, y: d.c })),
          type: currentChartType,
          borderColor: '#0b76d1',
          backgroundColor: currentChartType === 'bar' ? 'rgba(11, 118, 209, 0.6)' : 'rgba(11, 118, 209, 0.1)',
          fill: currentChartType !== 'bar',
          tension: 0.1
        });
      }

      if (currentIndicator !== 'none') {
        const n = parseInt(currentIndicator.replace('ma', ''));
        const closes = ohlc.map(d => d.c);
        const ma = simpleMovingAverage(closes, n);
        
        datasets.push({
          label: `MA${n}`,
          data: ma.map((v, i) => ({ x: ohlc[i].t, y: v })).filter(d => d.y !== null),
          type: 'line',
          borderColor: '#ff7f0e',
          backgroundColor: 'rgba(255, 127, 14, 0.1)',
          tension: 0.1,
          pointRadius: 0,
          borderDash: [5, 5]
        });
      }

      const config = {
        type: currentChartType === 'candlestick' ? 'candlestick' : 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: currentRange === '1D' ? 'hour' : 'day'
              }
            },
            y: {
              beginAtZero: false
            }
          }
        }
      };

      ohlcChart = new Chart(ctx, config);
    }

    function simpleMovingAverage(arr, n) {
      const res = [];
      for (let i = 0; i < arr.length; i++) {
        if (i < n - 1) {
          res.push(null);
        } else {
          let sum = 0;
          for (let j = 0; j < n; j++) {
            sum += arr[i - j] || 0;
          }
          res.push(sum / n);
        }
      }
      return res;
    }

    // REAL NEWS with working RSS feeds and images
    async function loadNews() {
      const now = Date.now();
      if (now - lastNewsUpdate < NEWS_UPDATE_INTERVAL && $('newsGrid').children.length > 1) {
        return;
      }
      lastNewsUpdate = now;

      try {
        // Use working RSS feeds with CORS proxy
        const feeds = [
          'https://feeds.reuters.com/reuters/businessNews',
          'https://feeds.reuters.com/reuters/topNews',
          'https://rss.cnn.com/rss/money_news_international.rss'
        ];

        let allItems = [];
        
        for (const feedUrl of feeds) {
          try {
            // Use RSS to JSON converter
            const proxyUrl = 'https://api.rss2json.com/v1/api.json?rss_url=';
            const response = await fetch(proxyUrl + encodeURIComponent(feedUrl));
            const data = await response.json();
            
            if (data.items && data.items.length > 0) {
              allItems = allItems.concat(data.items.map(item => ({
                title: item.title,
                link: item.link,
                description: item.description,
                pubDate: item.pubDate,
                imageUrl: item.enclosure?.link || item.thumbnail || getImageFromDescription(item.description)
              })));
            }
          } catch (feedError) {
            console.error('Error loading feed:', feedUrl, feedError);
          }
        }

        if (allItems.length === 0) {
          throw new Error('No news items loaded');
        }

        // Sort by date and take top 9
        allItems.sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
        const topItems = allItems.slice(0, 9);

        // Render news cards
        const newsGrid = $('newsGrid');
        newsGrid.innerHTML = topItems.map(item => {
          const imageUrl = item.imageUrl || 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=600&h=400&fit=crop';
          const title = item.title.length > 80 ? item.title.substring(0, 80) + '...' : item.title;
          
          return `
            <a class="newsCard" href="${item.link}" target="_blank" rel="noopener noreferrer">
              <img src="${imageUrl}" alt="${title}" onerror="this.src='https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=600&h=400&fit=crop'">
              <div class="body">
                <h5>${title}</h5>
                <div class="meta">${new Date(item.pubDate).toLocaleDateString()}</div>
              </div>
            </a>
          `;
        }).join('');

      } catch (error) {
        console.error('Error loading news:', error);
        $('newsGrid').innerHTML = '<div class="error">News temporarily unavailable. Please refresh.</div>';
      }
    }

    function getImageFromDescription(description) {
      if (!description) return null;
      const imgMatch = description.match(/<img[^>]+src="([^">]+)"/i);
      return imgMatch ? imgMatch[1] : null;
    }

    // Trading analysis with real data
    function computeSignalsFromOHLC(ohlc) {
      if (!ohlc || ohlc.length < 20) {
        return { recommendation: 'Hold', reason: 'Insufficient data for analysis' };
      }

      const closes = ohlc.map(d => d.c).filter(c => c > 0);
      const ma10 = simpleMovingAverage(closes, 10);
      const ma50 = simpleMovingAverage(closes, 50);
      
      const currentMA10 = ma10[ma10.length - 1];
      const currentMA50 = ma50[ma50.length - 1];
      const currentPrice = closes[closes.length - 1];

      const signal = { recommendation: 'Hold', reason: 'No clear trend detected' };

      if (currentMA10 > currentMA50 && currentPrice > currentMA10) {
        signal.recommendation = 'Buy';
        signal.reason = 'Bullish trend: Price above MA10 and MA10 above MA50';
      } else if (currentMA10 < currentMA50 && currentPrice < currentMA10) {
        signal.recommendation = 'Sell';
        signal.reason = 'Bearish trend: Price below MA10 and MA10 below MA50';
      }

      const shortTermMomentum = ((currentPrice - closes[closes.length - 5]) / closes[closes.length - 5]) * 100;
      if (Math.abs(shortTermMomentum) > 3) {
        signal.momentum = `${shortTermMomentum.toFixed(2)}% over last 5 periods`;
      }

      return signal;
    }

    function updateAdvisories(symbol, data) {
      const advisoriesEl = $('advisories');
      
      if (data.error) {
        advisoriesEl.innerHTML = `
          <div class="error">
            <strong>${symbol}</strong>: ${data.error}
          </div>
        `;
        return;
      }

      const signal = computeSignalsFromOHLC(data.ohlc);

      advisoriesEl.innerHTML = `
        <strong>${symbol}</strong>
        <div style="margin-top:6px">Recommendation: <strong>${signal.recommendation}</strong></div>
        <div class="meta" style="margin-top:6px">${signal.reason}</div>
        ${signal.momentum ? `<div class="meta" style="margin-top:6px">Momentum: ${signal.momentum}</div>` : ''}
        <div style="margin-top:10px;font-size:13px;color:#0b76d1">
          <strong>Live Data Analysis</strong> - Based on real market data
        </div>
      `;
    }

    async function loadCryptoAdvice() {
      try {
        const cryptoData = await fetchCoinGeckoMarkets();
        const cryptoAdviceEl = $('cryptoAdvice');
        
        const nodes = cryptoData.map(crypto => {
          const symbol = crypto.symbol?.toUpperCase() || 'CRYPTO';
          const price = crypto.current_price?.toLocaleString('en-US', {
            style: 'currency',
            currency: 'USD'
          }) || '$0.00';
          
          const change = crypto.price_change_percentage_24h || 0;
          const changeFormatted = change.toFixed(2);
          const changeColor = change >= 0 ? '#00cc00' : '#d32f2f';
          
          let recommendation = 'Hold';
          if (change > 8) recommendation = 'Consider Taking Profits';
          else if (change > 3) recommendation = 'Bullish - Monitor';
          else if (change < -8) recommendation = 'Potential Buying Opportunity';
          else if (change < -3) recommendation = 'Bearish - Caution';

          return `
            <div style="padding:8px 0;border-bottom:1px dashed #f1f6fb">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <strong>${symbol}</strong>
                <span>${price}</span>
              </div>
              <div class="meta" style="color:${changeColor}">
                24h: ${change >= 0 ? '+' : ''}${changeFormatted}%
              </div>
              <div style="margin-top:4px;font-size:12px;">
                <em>${recommendation}</em>
              </div>
            </div>
          `;
        });

        cryptoAdviceEl.innerHTML = nodes.join('');

      } catch (error) {
        console.error('Error loading crypto advice:', error);
        $('cryptoAdvice').innerHTML = `
          <div class="error">
            Unable to load live crypto data. Please try again later.
          </div>
        `;
      }
    }

    // REAL-TIME POSTS with actual data
    async function loadPosts() {
      const watchlist = getWatch().slice(0, 9);
      const postsArea = $('postsArea');
      
      postsArea.innerHTML = '<div class="loading">Loading live data...</div>';
      
      try {
        const posts = await Promise.all(
          watchlist.map(async (symbol) => {
            try {
              let priceData;
              
              // Determine data source based on symbol type
              if (symbol.length === 6 && symbol.match(/[A-Z]{6}/)) {
                // Forex pair
                priceData = await fetchForexData(symbol);
              } else if (['BTC', 'ETH', 'ADA', 'SOL', 'DOT', 'DOGE', 'XRP', 'LTC', 'BNB', 'LINK'].includes(symbol)) {
                // Crypto
                const cryptoData = await fetchCryptoData(symbol);
                priceData = {
                  current: cryptoData.ohlc[cryptoData.ohlc.length - 1]?.c || 0,
                  previous: cryptoData.ohlc[cryptoData.ohlc.length - 2]?.c || 0
                };
              } else {
                // Stock - use Alpha Vantage global quote
                const response = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${ALPHA_VANTAGE_API_KEY}`);
                const data = await response.json();
                const quote = data['Global Quote'];
                
                if (quote) {
                  priceData = {
                    current: parseFloat(quote['05. price']),
                    change: parseFloat(quote['09. change']),
                    changePercent: parseFloat(quote['10. change percent'])
                  };
                }
              }
              
              if (!priceData) {
                throw new Error('No price data');
              }
              
              const currentPrice = priceData.current || 0;
              const change = priceData.change || (currentPrice - (priceData.previous || currentPrice));
              const changePercent = priceData.changePercent || (change / (currentPrice - change)) * 100;
              
              const changeClass = change >= 0 ? 'green' : '';
              const changeSymbol = change >= 0 ? '+' : '';
              
              return `
                <div class="post">
                  <h4>${symbol}</h4>
                  <div class="meta">$${currentPrice.toFixed(2)}</div>
                  <div class="change ${changeClass}">
                    ${changeSymbol}${change.toFixed(2)} (${changeSymbol}${Math.abs(changePercent).toFixed(2)}%)
                  </div>
                  <div style="margin-top:4px;font-size:10px;color:#0b76d1">Live</div>
                </div>
              `;
            } catch (error) {
              console.error(`Error loading post for ${symbol}:`, error);
              return `
                <div class="post">
                  <h4>${symbol}</h4>
                  <div class="meta">Data unavailable</div>
                  <div class="change">--</div>
                </div>
              `;
            }
          })
        );
        
        postsArea.innerHTML = posts.join('');
        
      } catch (error) {
        console.error('Error loading posts:', error);
        postsArea.innerHTML = '<div class="error">Temporarily unable to load market data</div>';
      }
    }

    // MAIN SYMBOL LOADING - Uses real data sources
    async function loadSymbol(symbol, range = '1D') {
      if (!symbol || symbol.trim() === '') return;
      
      currentSymbol = symbol.toUpperCase().trim();
      currentRange = range;
      
      const chartTitle = $('chartTitle');
      const chartUpdated = $('chartUpdated');
      
      chartTitle.textContent = `Loading ${currentSymbol} (${range})...`;
      chartTitle.classList.add('loading');
      
      try {
        let data;
        
        // Determine data source based on symbol
        if (currentSymbol.length === 6 && currentSymbol.match(/[A-Z]{6}/)) {
          // Forex pair
          data = await fetchForexData(currentSymbol);
        } else if (['BTC', 'ETH', 'ADA', 'SOL', 'DOT', 'DOGE', 'XRP', 'LTC', 'BNB', 'LINK'].includes(currentSymbol)) {
          // Crypto
          data = await fetchCryptoData(currentSymbol);
        } else {
          // Stock
          data = await fetchStockData(currentSymbol, range);
        }
        
        // Render chart and update UI
        renderChart(data.ohlc, currentSymbol);
        chartUpdated.textContent = data.last ? new Date(data.last).toLocaleString() : 'Just now';
        updateAdvisories(currentSymbol, data);
        
        chartTitle.classList.remove('loading');
        chartTitle.textContent = `${currentSymbol} (${range}) - Live Data`;
        
      } catch (error) {
        console.error(`Error loading symbol ${currentSymbol}:`, error);
        
        chartTitle.classList.remove('loading');
        chartTitle.textContent = `${currentSymbol} (${range})`;
        chartUpdated.textContent = 'Data unavailable';
        
        $('advisories').innerHTML = `
          <div class="error">
            <strong>${currentSymbol}</strong>: ${error.message}
          </div>
          <div style="margin-top:8px;font-size:13px">
            Please try:<br>
            • A different symbol<br>
            • Refreshing the page<br>
            • Checking your internet connection
          </div>
        `;
      }
    }

    // Initialize the dashboard
    async function loadAll() {
      renderWatch();
      
      await Promise.allSettled([
        loadCryptoAdvice(),
        loadNews(),
        loadPosts()
      ]);
      
      // Setup UI controls
      const ranges = ['1D', '1W', '1M', '3M', '1Y'];
      const timeRangeDiv = $('timeRange');
      timeRangeDiv.innerHTML = ranges.map(range => 
        `<button class="${range === '1D' ? 'active' : ''}" data-range="${range}">${range}</button>`
      ).join('');
      
      timeRangeDiv.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          timeRangeDiv.querySelector('.active')?.classList.remove('active');
          btn.classList.add('active');
          if (currentSymbol) {
            loadSymbol(currentSymbol, btn.dataset.range);
          }
        });
      });
      
      const chartTypes = [
        { type: 'candlestick', label: 'Candlestick' },
        { type: 'line', label: 'Line' },
        { type: 'bar', label: 'Bar' }
      ];
      const chartTypeDiv = $('chartType');
      chartTypeDiv.innerHTML = chartTypes.map(({ type, label }) => 
        `<button class="${type === 'candlestick' ? 'active' : ''}" data-type="${type}">${label}</button>`
      ).join('');
      
      chartTypeDiv.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          chartTypeDiv.querySelector('.active')?.classList.remove('active');
          btn.classList.add('active');
          currentChartType = btn.dataset.type;
          if (currentSymbol) {
            loadSymbol(currentSymbol, currentRange);
          }
        });
      });
      
      $('indicatorSelect').addEventListener('change', (e) => {
        currentIndicator = e.target.value;
        if (currentSymbol) {
          loadSymbol(currentSymbol, currentRange);
        }
      });
      
      const firstSymbol = getWatch()[0];
      if (firstSymbol) {
        loadSymbol(firstSymbol);
      }
    }

    // Event listeners
    $('loadBtn').addEventListener('click', () => {
      const symbol = $('globalSearch').value.trim();
      if (!symbol) {
        alert('Please enter a symbol');
        return;
      }
      
      const watchlist = getWatch();
      if (!watchlist.includes(symbol.toUpperCase())) {
        watchlist.unshift(symbol.toUpperCase());
        saveWatch(watchlist);
        renderWatch();
      }
      
      $('globalSearch').value = '';
      loadSymbol(symbol);
    });

    $('globalSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        $('loadBtn').click();
      }
    });

    $('sendBtn').addEventListener('click', () => {
      const name = $('name').value.trim();
      const email = $('email').value.trim();
      const message = $('message').value.trim();
      
      if (!name || !email || !message) {
        $('sendStatus').textContent = 'Please fill all fields.';
        return;
      }
      
      const subject = `Contact from ${name} - Market Pulse Dashboard`;
      const body = `Message: ${message}\n\nFrom: ${name} <${email}>`;
      
      window.location.href = `mailto:wambuamwanza6@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      $('sendStatus').textContent = 'Opening email client...';
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadAll();
      
      setInterval(() => {
        loadPosts();
        if (Date.now() - lastNewsUpdate >= NEWS_UPDATE_INTERVAL) {
          loadNews();
        }
        // Refresh current symbol every 2 minutes
        if (currentSymbol) {
          loadSymbol(currentSymbol, currentRange);
        }
      }, 120000);
    });
  </script>
</body>
</html>
