<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Market Pulse — Global Markets Dashboard (Advanced)</title>
  <meta name="description" content="Advanced finance dashboard with candlestick charts, indicators, trade advisories, crypto/forex signals and news thumbnails." />

  <!-- Chart.js + Financial plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.0/dist/chartjs-chart-financial.min.js"></script>

  <style>
    html, body { all: unset; display: block; height: 100%; }
    * { box-sizing: border-box; }
    body { font-family: Inter, Segoe UI, Roboto, Arial, sans-serif; background: #f6f8fb; margin: 0; padding: 18px; color: #0b2240; }
    #app { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 18px; border: 1px solid #e6eef6; box-shadow: 0 12px 40px rgba(13, 30, 50, 0.06); }
    .header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid #e6eef6; }
    .brand { display: flex; gap: 12px; align-items: center; }
    .logo { width: 56px; height: 56px; border-radius: 10px; background: linear-gradient(135deg, #e6f2ff, #fff); display: flex; align-items: center; justify-content: center; font-weight: 800; color: #0b76d1; }
    .title { font-size: 18px; font-weight: 700; }
    .subtitle { font-size: 13px; color: #6b7b8c; }
    .controls { display: flex; gap: 8px; align-items: center; }
    .controls input, .controls select { padding: 8px; border-radius: 8px; border: 1px solid #dcebf7; font-size: 14px; }
    .controls button { padding: 8px 12px; border-radius: 8px; border: none; background: #0b76d1; color: #fff; cursor: pointer; font-size: 14px; }
    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 18px; margin-top: 16px; }
    .left { display: flex; flex-direction: column; gap: 12px; }
    .card { background: #fff; border: 1px solid #eef6fb; border-radius: 10px; padding: 12px; }
    .chartCard { display: flex; flex-direction: column; }
    .chartToolbar { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; }
    .chartWrap { height: 420px; position: relative; }
    .timeRange { display: flex; gap: 4px; }
    .timeRange button { padding: 4px 8px; font-size: 12px; background: #f1f6fb; border: 1px solid #dcebf7; border-radius: 4px; cursor: pointer; }
    .timeRange button.active { background: #0b76d1; color: #fff; }
    .newsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .newsCard { background: #fff; border: 1px solid #eef6fb; border-radius: 8px; overflow: hidden; text-decoration: none; color: inherit; display: block; transition: transform 0.2s; }
    .newsCard:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .newsCard img { width: 100%; height: 140px; object-fit: cover; }
    .newsCard .body { padding: 10px; }
    .newsCard h5 { margin: 0 0 6px 0; font-size: 15px; }
    .newsCard .meta { font-size: 12px; color: #6b7b8c; }
    .postsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .post { padding: 12px; border-radius: 8px; background: linear-gradient(180deg, #fff, #fbfdff); border: 1px solid #eef6fb; display: flex; flex-direction: column; justify-content: space-between; }
    .post h4 { margin: 0 0 6px 0; font-size: 16px; }
    .post .meta { font-size: 14px; color: #0b2240; }
    .post .change { font-size: 14px; color: #d32f2f; }
    .post .change.green { color: #00cc00; }
    footer { margin-top: 18px; padding-top: 12px; border-top: 1px solid #eef6fb; display: flex; justify-content: space-between; align-items: flex-start; gap: 18px; }
    .contact input, .contact textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #dcebf7; margin-top: 8px; }
    .contact button { margin-top: 8px; padding: 10px 12px; border-radius: 8px; border: none; background: #0b76d1; color: #fff; cursor: pointer; }
    .advice { background: linear-gradient(180deg, #fff, #fbfdff); padding: 10px; border-radius: 8px; border: 1px solid #eef6fb; }
    .error { color: #d32f2f; font-style: italic; }
    @media (max-width: 1100px) { .newsGrid, .postsGrid { grid-template-columns: repeat(2, 1fr); } .grid { grid-template-columns: 1fr; } }
    @media (max-width: 700px) { .newsGrid, .postsGrid { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <div class="brand">
        <div class="logo">MP</div>
        <div>
          <div class="title">Market Pulse — Global (Advanced)</div>
          <div class="subtitle">Candlesticks, indicators, trade advisories & curated news</div>
        </div>
      </div>
      <div class="controls">
        <input id="globalSearch" placeholder="Symbol e.g. AAPL, TSLA, BTC, EURUSD">
        <button id="loadBtn">Load</button>
      </div>
    </div>

    <main class="grid">
      <aside class="left">
        <div class="card">
          <h4>Watchlist</h4>
          <div id="watchlist">Loading…</div>
          <div style="margin-top:8px"><small class="meta">Tip: Add any global ticker (US/EU/Asia). For forex use EURUSD, for crypto use BTC, ETH etc.</small></div>
        </div>
        <div class="card">
          <h4>Quick Trade Advisories</h4>
          <div id="advisories" class="advice">Loading advisories…</div>
        </div>
        <div class="card">
          <h4>Crypto Suggestions</h4>
          <div id="cryptoAdvice" class="advice">Loading crypto suggestions…</div>
        </div>
      </aside>
      <section>
        <div class="card chartCard">
          <div class="chartToolbar">
            <div><strong id="chartTitle">Select a symbol</strong></div>
            <div style="margin-left:auto" class="meta">Updated: <span id="chartUpdated">—</span></div>
            <div class="timeRange" id="timeRange"></div>
          </div>
          <div class="chartWrap"><canvas id="ohlcChart"></canvas></div>
          <div style="margin-top:12px">
            <strong>Market News</strong>
            <div class="newsGrid" id="newsGrid">Loading news…</div>
          </div>
        </div>
        <div class="card" style="margin-top:12px">
          <h4 style="margin-top:0">Market Watch Posts</h4>
          <div class="postsGrid" id="postsArea">Loading posts…</div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        <div style="font-weight:700">Market Pulse</div>
        <div class="meta">Advanced dashboard — data via Alpha Vantage & CoinGecko</div>
      </div>
      <div class="contact card" style="width:360px">
        <strong>Contact</strong>
        <div class="meta">Messages will be prepared for: <strong>wambuamwanza6@gmail.com</strong></div>
        <input id="name" placeholder="Your name" />
        <input id="email" placeholder="Your email" />
        <textarea id="message" rows="4" placeholder="Your message"></textarea>
        <button id="sendBtn">Send</button>
        <div id="sendStatus" class="meta" style="margin-top:8px"></div>
      </div>
    </footer>
  </div>

  <script>
    // CONFIG
    const ALPHA_KEY = 'demo'; // Demo key; replace with your free key from alphavantage.co
    const RSS_PROXY = 'https://api.allorigins.win/raw?url=';

    // Helpers
    const $ = id => document.getElementById(id);

    // Watchlist storage
    function getWatch() {
      try {
        return JSON.parse(localStorage.getItem('mp_watch') || '["AAPL","MSFT","GOOGL","TSLA","AMZN"]');
      } catch (e) {
        return ['AAPL', 'MSFT', 'GOOGL', 'TSLA', 'AMZN'];
      }
    }
    function saveWatch(a) {
      localStorage.setItem('mp_watch', JSON.stringify(a));
    }

    function renderWatch() {
      const list = getWatch();
      if (list.length === 0) {
        $('watchlist').textContent = 'No symbols.';
        return;
      }
      $('watchlist').innerHTML = list.map(s => `
        <div style="padding:8px 0;border-bottom:1px dashed #f1f6fb">
          <strong>${s}</strong>
        </div>
      `).join('');
    }

    // Add via controls
    $('loadBtn').addEventListener('click', () => {
      const val = $('globalSearch').value.trim().toUpperCase();
      if (!val) return;
      const arr = getWatch();
      if (!arr.includes(val)) {
        arr.unshift(val);
        saveWatch(arr);
        renderWatch();
      }
      $('globalSearch').value = '';
      loadSymbol(val);
    });

    // TIME SERIES FETCH & OHLC conversion
    async function fetchAlphaIntraday(symbol, interval, days = '1') {
      const url = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${encodeURIComponent(symbol)}&outputsize=compact&apikey=${ALPHA_KEY}`;
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        if (j['Error Message'] || j['Note']) throw new Error(j['Error Message'] || j['Note']);
        const ts = j['Time Series (Daily)'] || null;
        if (!ts) return { error: 'No time series data' };
        const keys = Object.keys(ts).sort().reverse().slice(0, days === '1' ? 100 : days * 30);
        const ohlc = keys.map(k => ({
          t: new Date(k).getTime(),
          o: Number(ts[k]['1. open']),
          h: Number(ts[k]['2. high']),
          l: Number(ts[k]['3. low']),
          c: Number(ts[k]['4. close'])
        }));
        return { ohlc, last: keys[0] };
      } catch (e) {
        console.error('Alpha Intraday fetch error:', e);
        return { error: e.message };
      }
    }

    async function fetchCoinGecko(id, days = 1) {
      try {
        const r = await fetch(`https://api.coingecko.com/api/v3/coins/${id}/ohlc?vs_currency=usd&days=${days}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const j = await r.json();
        const ohlc = j.map(item => ({
          t: item[0],
          o: item[1],
          h: item[2],
          l: item[3],
          c: item[4]
        }));
        return { ohlc, last: ohlc.length ? new Date(ohlc[ohlc.length - 1].t).toISOString() : null };
      } catch (e) {
        console.error('CoinGecko fetch error:', e);
        return null;
      }
    }

    // Render candlestick chart
    let ohlcChart = null;
    let currentSymbol = '';
    let currentRange = '1D';
    function renderOHLC(ohlc, label, maOption) {
      if (ohlc.length === 0) return;
      const ctx = $('ohlcChart').getContext('2d');
      if (ohlcChart) ohlcChart.destroy();
      const datasets = [{
        label: label,
        data: ohlc.map(d => ({ x: d.t, o: d.o, h: d.h, l: d.l, c: d.c })),
        type: 'candlestick',
        borderColor: { up: '#00cc00', down: '#ff3333', unchanged: '#999999' }
      }];

      if (maOption && maOption !== 'none') {
        const n = Number(maOption.replace('ma', ''));
        const closes = ohlc.map(d => d.c);
        const ma = simpleMovingAverage(closes, n);
        datasets.push({
          label: `MA${n}`,
          type: 'line',
          data: ma.map((v, i) => ({ x: ohlc[i].t, y: v })).filter(d => d.y !== null),
          borderColor: '#ff7f0e',
          backgroundColor: 'rgba(255,127,14,0.08)',
          tension: 0.2,
          pointRadius: 0
        });
      }

      ohlcChart = new Chart(ctx, {
        data: { datasets },
        options: {
          responsive: true,
          plugins: { legend: { display: true } },
          scales: {
            x: { type: 'time', time: { unit: currentRange === '1D' ? 'hour' : 'day' } },
            y: { beginAtZero: false }
          }
        }
      });
    }

    function simpleMovingAverage(arr, n) {
      const res = [];
      for (let i = 0; i < arr.length; i++) {
        if (i < n - 1) res.push(null);
        else {
          let sum = 0;
          for (let j = 0; j < n; j++) sum += arr[i - j];
          res.push(sum / n);
        }
      }
      return res;
    }

    // News loading
    async function parseRSS(xmlText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(xmlText, 'text/xml');
      const items = doc.querySelectorAll('item');
      return Array.from(items).map(item => ({
        title: item.querySelector('title')?.textContent || '',
        link: item.querySelector('link')?.textContent || '',
        description: item.querySelector('description')?.textContent || '',
        pubDate: item.querySelector('pubDate')?.textContent || ''
      }));
    }

    async function loadNews() {
      const feeds = [
        'https://feeds.reuters.com/reuters/businessNews',
        'http://feeds.bbci.co.uk/news/business/rss.xml',
        'https://www.cnbc.com/id/100003114/device/rss/rss.html'
      ];
      let allItems = [];
      for (const feedUrl of feeds) {
        try {
          const proxied = RSS_PROXY + encodeURIComponent(feedUrl);
          const r = await fetch(proxied);
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const xmlText = await r.text();
          const items = await parseRSS(xmlText);
          allItems.push(...items);
        } catch (e) {
          console.error(`Failed to load ${feedUrl}:`, e);
        }
      }
      if (allItems.length === 0) {
        $('newsGrid').innerHTML = '<div class="error" style="grid-column:1/-1;text-align:center;padding:20px">Failed to load news.</div>';
        return;
      }
      const top = allItems.slice(0, 9).sort((a, b) => new Date(b.pubDate) - new Date(a.pubDate));
      const nodes = top.map(it => {
        const imgMatch = it.description.match(/<img[^>]+src="([^">]+)"/i);
        const img = imgMatch ? imgMatch[1] : 'https://via.placeholder.com/600x400?text=News';
        return `
          <a class="newsCard" href="${it.link}" target="_blank" rel="noreferrer">
            <img src="${img}" alt="thumb" onerror="this.src='https://via.placeholder.com/600x400?text=News'">
            <div class="body">
              <h5>${it.title}</h5>
              <div class="meta">${new Date(it.pubDate).toLocaleDateString()}</div>
            </div>
          </a>
        `;
      });
      $('newsGrid').innerHTML = nodes.join('');
    }

    // Trading advisory rules
    function computeSignalsFromOHLC(ohlc) {
      if (ohlc.length < 50) return { recommendation: 'Hold', reason: 'Insufficient data' };
      const closes = ohlc.map(d => d.c);
      const ma10 = closes.map((v, i) => i < 9 ? null : closes.slice(i - 9, i + 1).reduce((a, b) => a + b, 0) / 10);
      const ma50 = closes.map((v, i) => i < 49 ? null : closes.slice(i - 49, i + 1).reduce((a, b) => a + b, 0) / 50);
      const idx = closes.length - 1;
      const signal = { recommendation: 'Hold', reason: 'No clear signal' };
      if (ma10[idx] && ma50[idx]) {
        if (ma10[idx] > ma50[idx]) {
          signal.recommendation = 'Buy';
          signal.reason = 'MA10 crossed above MA50 (bullish)';
        } else if (ma10[idx] < ma50[idx]) {
          signal.recommendation = 'Sell';
          signal.reason = 'MA10 below MA50 (bearish)';
        }
      }
      const prev = closes[closes.length - 5] || closes[0];
      const changePct = ((closes[idx] - prev) / prev) * 100;
      if (Math.abs(changePct) > 2) {
        signal.momentum = changePct.toFixed(2) + '% over last 5 days';
      }
      return signal;
    }

    async function updateAdvisories(symbol, ohlc) {
      const s = computeSignalsFromOHLC(ohlc);
      $('advisories').innerHTML = `
        <strong>${symbol}</strong>
        <div style="margin-top:6px">Recommendation: <strong>${s.recommendation}</strong></div>
        <div class="meta" style="margin-top:6px">${s.reason}</div>
        ${s.momentum ? `<div class="meta" style="margin-top:6px">Momentum: ${s.momentum}</div>` : ''}
        <div style="margin-top:10px;font-size:13px">Note: Forex: Use tight stops. Crypto: Dollar-cost average.</div>
      `;
    }

    async function loadCryptoAdvice() {
      try {
        const r = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=10&page=1&sparkline=false');
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        const js = await r.json();
        const nodes = js.map(c => {
          const change = Number(c.price_change_percentage_24h || 0).toFixed(2);
          let rec = 'Hold';
          if (change > 5 && c.total_volume > 50000000) rec = 'Consider Selling';
          if (change < -7 && c.total_volume > 20000000) rec = 'Consider Buying';
          return `
            <div style="padding:6px 0;border-bottom:1px dashed #f1f6fb">
              <strong>${c.symbol.toUpperCase()}</strong> $${c.current_price.toLocaleString()}
              <div class="meta">24h: ${change}%</div>
              <div style="margin-top:6px"><em>${rec}</em></div>
            </div>
          `;
        });
        $('cryptoAdvice').innerHTML = nodes.join('');
      } catch (e) {
        $('cryptoAdvice').innerHTML = '<div class="error">Failed to load crypto suggestions.</div>';
      }
    }

    // Load symbol with time range
    async function loadSymbol(symbol, range = '1D') {
      if (!symbol) return;
      currentSymbol = symbol;
      currentRange = range;
      $('chartTitle').textContent = `Loading ${symbol} (${range})...`;
      let res;
      try {
        res = await fetchAlphaIntraday(symbol, 'daily', range === '1D' ? 1 : range === '1W' ? 7 : range === '1M' ? 30 : range === '3M' ? 90 : range === '1Y' ? 365 : 1825);
        if (res.error) {
          const listRes = await fetch('https://api.coingecko.com/api/v3/coins/list');
          const list = await listRes.json();
          const found = list.find(x => x.symbol.toLowerCase() === symbol.toLowerCase());
          if (found) {
            res = await fetchCoinGecko(found.id, range === '1D' ? 1 : range === '1W' ? 7 : range === '1M' ? 30 : range === '3M' ? 90 : range === '1Y' ? 365 : 1825);
          }
        }
        if (res && res.ohlc && res.ohlc.length > 0) {
          renderOHLC(res.ohlc, symbol, 'ma50'); // Default to MA50
          $('chartUpdated').textContent = res.last ? new Date(res.last).toLocaleString() : '--';
          updateAdvisories(symbol, res.ohlc);
        } else {
          $('chartTitle').textContent = `${symbol} (${range}) — No data`;
          $('chartUpdated').textContent = '--';
          updateAdvisories(symbol, { error: 'No data available' });
        }
      } catch (e) {
        console.error('Load symbol error:', e);
        $('chartTitle').textContent = `${symbol} (${range}) — Error`;
        $('chartUpdated').textContent = '--';
        updateAdvisories(symbol, { error: e.message });
      }
    }

    // Posts
    async function loadPosts() {
      const watch = getWatch().slice(0, 9);
      const area = $('postsArea');
      area.innerHTML = '';
      const nodes = [];
      for (const s of watch) {
        try {
          const r = await fetch(`https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${s}&apikey=${ALPHA_KEY}`);
          if (!r.ok) throw new Error(`HTTP ${r.status}`);
          const j = await r.json();
          if (j['Error Message'] || j['Note']) throw new Error(j['Error Message'] || j['Note']);
          const q = j['Global Quote'];
          const price = q ? Number(q['05. price']).toFixed(2) : '—';
          const change = q ? Number(q['09. change']).toFixed(2) : '—';
          const changePercent = q ? Number(q['10. change percent'].replace('%', '')).toFixed(2) : '—';
          const changeClass = change > 0 ? 'green' : change < 0 ? '' : 'neutral';
          nodes.push(`
            <div class="post">
              <h4>${s}</h4>
              <div class="meta">${price}</div>
              <div class="change ${changeClass}">${change} (${changePercent}%)</div>
            </div>
          `);
        } catch (e) {
          nodes.push(`<div class="post"><h4>${s}</h4><div class="meta error">data error</div></div>`);
        }
      }
      area.innerHTML = nodes.join('');
    }

    // Init & auto refresh
    async function loadAll() {
      renderWatch();
      await Promise.allSettled([loadCryptoAdvice(), loadNews(), loadPosts()]);
      // Initialize time range buttons
      const ranges = ['1D', '1W', '1M', '3M', '1Y', '5Y'];
      const timeRangeDiv = $('timeRange');
      timeRangeDiv.innerHTML = ranges.map(r => `<button class="${r === '1D' ? 'active' : ''}" data-range="${r}">${r}</button>`).join('');
      timeRangeDiv.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          timeRangeDiv.querySelector('.active').classList.remove('active');
          btn.classList.add('active');
          if (currentSymbol) loadSymbol(currentSymbol, btn.dataset.range);
        });
      });
    }

    $('sendBtn').addEventListener('click', () => {
      const n = $('name').value.trim();
      const e = $('email').value.trim();
      const m = $('message').value.trim();
      if (!n || !e || !m) {
        $('sendStatus').textContent = 'Please fill all fields.';
        return;
      }
      const subject = encodeURIComponent('Contact from ' + n);
      const body = encodeURIComponent(m + '\n\nFrom: ' + n + ' <' + e + '>');
      window.location.href = 'mailto:wambuamwanza6@gmail.com?subject=' + subject + '&body=' + body;
      $('sendStatus').textContent = 'Opening mail client...';
    });

    (async function boot() {
      await loadAll();
      const first = getWatch()[0];
      if (first) loadSymbol(first);
      setInterval(loadPosts, 120000);
    })();
  </script>
</body>
</html>
