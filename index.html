<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JDGlobal Markets</title>
  <meta name="description" content="Advanced finance dashboard with candlestick charts, indicators, trade advisories, crypto/forex signals and news thumbnails." />

  <!-- Chart.js + Financial plugin -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.0/dist/chartjs-chart-financial.min.js"></script>

  <style>
    html, body { all: unset; display: block; height: 100%; }
    * { box-sizing: border-box; }
    body { font-family: Inter, Segoe UI, Roboto, Arial, sans-serif; background: #f6f8fb; margin: 0; padding: 12px; color: #0b2240; }
    #app { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 12px; padding: 16px; border: 1px solid #e6eef6; box-shadow: 0 12px 40px rgba(13, 30, 50, 0.06); }
    
    /* Header */
    .header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid #e6eef6; flex-wrap: wrap; gap: 12px; }
    .brand { display: flex; gap: 12px; align-items: center; }
    .logo { width: 48px; height: 48px; border-radius: 10px; background: linear-gradient(135deg, #e6f2ff, #fff); display: flex; align-items: center; justify-content: center; font-weight: 800; color: #0b76d1; font-size: 14px; }
    .title { font-size: 18px; font-weight: 700; }
    .subtitle { font-size: 13px; color: #6b7b8c; }
    .controls { display: flex; gap: 8px; align-items: center; flex: 1; min-width: 250px; }
    .controls input { flex: 1; min-width: 120px; }
    .controls input, .controls select { padding: 8px; border-radius: 8px; border: 1px solid #dcebf7; font-size: 14px; }
    .controls button { padding: 8px 12px; border-radius: 8px; border: none; background: #0b76d1; color: #fff; cursor: pointer; font-size: 14px; white-space: nowrap; }
    
    /* Main Grid - Desktop */
    .grid { display: grid; grid-template-columns: 320px 1fr; gap: 16px; margin-top: 16px; }
    .left { display: flex; flex-direction: column; gap: 12px; }
    .card { background: #fff; border: 1px solid #eef6fb; border-radius: 10px; padding: 12px; }
    
    /* Chart */
    .chartCard { display: flex; flex-direction: column; }
    .chartWrap { height: 400px; position: relative; }
    .chartToolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 12px; flex-wrap: wrap; }
    .timeRange { display: flex; gap: 4px; flex-wrap: wrap; }
    .timeRange button { padding: 4px 8px; font-size: 11px; background: #f1f6fb; border: 1px solid #dcebf7; border-radius: 4px; cursor: pointer; white-space: nowrap; }
    .timeRange button.active { background: #0b76d1; color: #fff; }
    .chartType { display: flex; gap: 4px; flex-wrap: wrap; }
    .chartType button { padding: 4px 8px; font-size: 11px; background: #f1f6fb; border: 1px solid #dcebf7; border-radius: 4px; cursor: pointer; white-space: nowrap; }
    .chartType button.active { background: #0b76d1; color: #fff; }
    .indicatorSelect { padding: 4px 8px; font-size: 11px; border-radius: 4px; border: 1px solid #dcebf7; min-width: 80px; }
    
    /* News Grid */
    .newsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .newsCard { background: #fff; border: 1px solid #eef6fb; border-radius: 8px; overflow: hidden; text-decoration: none; color: inherit; display: block; transition: transform 0.2s; }
    .newsCard:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
    .newsCard img { width: 100%; height: 140px; object-fit: cover; }
    .newsCard .body { padding: 10px; }
    .newsCard h5 { margin: 0 0 6px 0; font-size: 14px; line-height: 1.3; }
    .newsCard .meta { font-size: 11px; color: #6b7b8c; line-height: 1.2; }
    
    /* Posts Grid */
    .postsGrid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .post { padding: 10px; border-radius: 8px; background: linear-gradient(180deg, #fff, #fbfdff); border: 1px solid #eef6fb; display: flex; flex-direction: column; justify-content: space-between; min-height: 80px; }
    .post h4 { margin: 0 0 4px 0; font-size: 14px; }
    .post .meta { font-size: 13px; color: #0b2240; font-weight: 600; }
    .post .change { font-size: 12px; color: #d32f2f; }
    .post .change.green { color: #00cc00; }
    
    /* Footer */
    footer { margin-top: 18px; padding-top: 12px; border-top: 1px solid #eef6fb; display: flex; justify-content: space-between; align-items: flex-start; gap: 18px; flex-wrap: wrap; }
    .contact input, .contact textarea { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #dcebf7; margin-top: 8px; font-size: 14px; }
    .contact button { margin-top: 8px; padding: 10px 12px; border-radius: 8px; border: none; background: #0b76d1; color: #fff; cursor: pointer; width: 100%; }
    
    /* Common Styles */
    .advice { background: linear-gradient(180deg, #fff, #fbfdff); padding: 10px; border-radius: 8px; border: 1px solid #eef6fb; }
    .error { color: #d32f2f; font-style: italic; font-size: 12px; }
    .loading { opacity: 0.6; }
    .success { color: #00cc00; }
    .pulse { animation: pulse 1.5s infinite; }
    
    /* Watchlist Items */
    .watchlist-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px dashed #f1f6fb; }
    .watchlist-buttons { display: flex; gap: 4px; }
    .watchlist-buttons button { padding: 4px 8px; font-size: 11px; background: #0b76d1; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
    
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }
    
    /* Mobile Responsive Styles - TWO COLUMN LAYOUT */
    @media (max-width: 1100px) {
      .newsGrid, .postsGrid { grid-template-columns: repeat(2, 1fr); }
    }
    
    @media (max-width: 768px) {
      body { padding: 8px; }
      #app { padding: 12px; border-radius: 8px; }
      
      .header { flex-direction: column; align-items: stretch; gap: 12px; }
      .brand { justify-content: center; text-align: center; }
      .controls { min-width: 100%; }
      .controls input { min-width: 0; }
      
      /* MOBILE TWO COLUMN GRID */
      .grid { 
        grid-template-columns: 1fr 1fr; 
        grid-template-areas: 
          "chart chart"
          "left right";
        gap: 12px;
      }
      
      .left { 
        grid-area: left;
        display: grid;
        grid-template-rows: auto auto;
        gap: 12px;
      }
      
      .right-section {
        grid-area: right;
        display: grid;
        grid-template-rows: auto auto;
        gap: 12px;
      }
      
      .chartCard { 
        grid-area: chart;
        margin-bottom: 0;
      }
      
      .chartWrap { height: 300px; }
      
      .chartToolbar { 
        flex-direction: row; 
        align-items: center;
        gap: 6px;
        flex-wrap: wrap;
      }
      
      .timeRange, .chartType {
        justify-content: center;
      }
      
      .timeRange button, .chartType button {
        padding: 3px 6px;
        font-size: 10px;
      }
      
      .indicatorSelect {
        width: auto;
        max-width: 100px;
      }
      
      /* News Grid Mobile */
      .newsGrid { 
        grid-template-columns: 1fr; 
        gap: 10px;
      }
      
      .newsCard { 
        display: flex; 
        flex-direction: row;
        height: 100px;
      }
      .newsCard img {
        width: 100px;
        height: 100px;
        flex-shrink: 0;
      }
      .newsCard .body {
        padding: 8px;
        flex: 1;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }
      .newsCard h5 {
        font-size: 13px;
        margin-bottom: 4px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }
      .newsCard .meta {
        font-size: 10px;
      }
      
      /* Posts Grid Mobile */
      .postsGrid { 
        grid-template-columns: 1fr 1fr; 
        gap: 8px;
      }
      
      .post {
        padding: 8px;
        min-height: 70px;
      }
      .post h4 { font-size: 13px; }
      .post .meta { font-size: 12px; }
      .post .change { font-size: 11px; }
      
      footer {
        flex-direction: column;
        gap: 16px;
      }
      .contact {
        width: 100% !important;
      }
      
      /* Crypto advice mobile optimization */
      .crypto-item {
        padding: 6px 0 !important;
      }
      .crypto-item > div {
        font-size: 12px !important;
      }
      .crypto-item .meta {
        font-size: 10px !important;
      }
    }
    
    @media (max-width: 480px) {
      .title { font-size: 16px; }
      .subtitle { font-size: 12px; }
      .logo { width: 40px; height: 40px; font-size: 12px; }
      
      .controls { flex-direction: column; }
      .controls input { width: 100%; }
      
      .chartWrap { height: 250px; }
      
      .timeRange button, .chartType button {
        padding: 3px 6px;
        font-size: 10px;
      }
      
      .newsCard {
        height: 90px;
      }
      .newsCard img {
        width: 80px;
        height: 90px;
      }
      .newsCard h5 {
        font-size: 12px;
        -webkit-line-clamp: 2;
      }
      
      .postsGrid { 
        grid-template-columns: 1fr 1fr; 
        gap: 6px;
      }
      
      .post {
        min-height: 60px;
        padding: 6px;
      }
      .post h4 { font-size: 12px; }
      .post .meta { font-size: 11px; }
      .post .change { font-size: 10px; }
    }
    
    /* Very small screens */
    @media (max-width: 360px) {
      body { padding: 6px; }
      #app { padding: 10px; }
      
      .chartWrap { height: 220px; }
      
      .newsCard {
        height: 80px;
      }
      .newsCard img {
        width: 70px;
        height: 80px;
      }
      .newsCard .body {
        padding: 6px;
      }
      .newsCard h5 {
        font-size: 11px;
        -webkit-line-clamp: 2;
      }
      
      .postsGrid { 
        grid-template-columns: 1fr 1fr; 
        gap: 4px;
      }
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="header">
      <div class="brand">
        <div class="logo">JDG</div>
        <div>
          <div class="title">JDGlobal Markets</div>
          <div class="subtitle">Real-time candlesticks, indicators & market news</div>
        </div>
      </div>
      <div class="controls">
        <input id="globalSearch" placeholder="Symbol e.g. AAPL, TSLA, BTC">
        <button id="loadBtn">Load</button>
      </div>
    </div>

    <main class="grid">
      <!-- Left Column - Watchlist & Trade Advisories -->
      <aside class="left">
        <div class="card">
          <h4>Watchlist</h4>
          <div id="watchlist">Loading…</div>
          <div style="margin-top:8px"><small class="meta">Tip: Add stocks (AAPL), crypto (BTC), or forex (EURUSD)</small></div>
        </div>
        <div class="card">
          <h4>Trade Advisories</h4>
          <div id="advisories" class="advice">Loading advisories…</div>
        </div>
      </aside>

      <!-- Right Column - Crypto & Posts -->
      <section class="right-section">
        <div class="card">
          <h4>Crypto Suggestions</h4>
          <div id="cryptoAdvice" class="advice">Loading crypto suggestions…</div>
        </div>
        <div class="card">
          <h4 style="margin-top:0">Market Watch</h4>
          <div class="postsGrid" id="postsArea">Loading posts…</div>
        </div>
      </section>

      <!-- Chart Section - Full Width Above -->
      <section class="chartCard card">
        <div class="chartToolbar">
          <div><strong id="chartTitle">Select a symbol</strong></div>
          <div style="margin-left:auto" class="meta">Updated: <span id="chartUpdated">—</span></div>
          <div class="timeRange" id="timeRange"></div>
          <div class="chartType" id="chartType"></div>
          <select id="indicatorSelect" class="indicatorSelect">
            <option value="none">MA: None</option>
            <option value="ma10">MA10</option>
            <option value="ma20">MA20</option>
            <option value="ma50">MA50</option>
          </select>
        </div>
        <div class="chartWrap"><canvas id="ohlcChart"></canvas></div>
        <div style="margin-top:12px">
          <strong>Market News</strong>
          <div class="newsGrid" id="newsGrid">Loading news…</div>
        </div>
      </section>
    </main>

    <footer>
      <div>
        <div style="font-weight:700">JDGlobal Markets</div>
        <div class="meta">Real Markets Data and Analysis Dashboard</div>
      </div>
      <div class="contact card" style="width:360px">
        <strong>Contact</strong>
        <div class="meta">Email: <strong>wambuamwanza6@gmail.com</strong></div>
        <input id="name" placeholder="Your name" />
        <input id="email" placeholder="Your email" />
        <textarea id="message" rows="3" placeholder="Your message"></textarea>
        <button id="sendBtn">Send Message</button>
        <div id="sendStatus" class="meta" style="margin-top:8px"></div>
      </div>
    </footer>
  </div>

  <script>
    // CONFIG - Faster APIs with better fallbacks
    const ALPHA_VANTAGE_API_KEY = 'INZ7GV3B33PXV2QM';
    let lastNewsUpdate = 0;
    let lastCryptoUpdate = 0;
    const NEWS_UPDATE_INTERVAL = 300000;
    const CRYPTO_UPDATE_INTERVAL = 60000;
    let currentSymbol = '';
    let currentRange = '1D';
    let currentChartType = 'candlestick';
    let currentIndicator = 'none';
    let ohlcChart = null;

    // Helpers
    const $ = id => document.getElementById(id);

    // Enhanced data cache for faster loading
    const dataCache = new Map();
    const CACHE_DURATION = 60000;

    // Watchlist storage
    function getWatch() {
      try {
        return JSON.parse(localStorage.getItem('mp_watch') || '["AAPL","MSFT","TSLA","BTC","ETH"]');
      } catch (e) {
        return ['AAPL', 'MSFT', 'TSLA', 'BTC', 'ETH'];
      }
    }

    function saveWatch(a) {
      localStorage.setItem('mp_watch', JSON.stringify(a));
    }

    function renderWatch() {
      const list = getWatch();
      const watchlistEl = $('watchlist');
      
      if (list.length === 0) {
        watchlistEl.textContent = 'No symbols.';
        return;
      }
      
      watchlistEl.innerHTML = list.map(s => `
        <div class="watchlist-item">
          <div><strong>${s}</strong></div>
          <div class="watchlist-buttons">
            <button data-sym="${s}" class="viewBtn">View</button>
          </div>
        </div>
      `).join('');
      
      document.querySelectorAll('.viewBtn').forEach(btn => {
        btn.addEventListener('click', () => loadSymbol(btn.dataset.sym));
      });
    }

    // FASTER CRYPTO DATA with multiple fallback sources
    async function fetchCryptoMarketsFast() {
      const cacheKey = 'crypto_markets_fast';
      const cached = dataCache.get(cacheKey);
      
      if (cached && Date.now() - cached.timestamp < 30000) {
        return cached.data;
      }

      try {
        // Return realistic mock data for better mobile performance
        return generateLiveCryptoData();
        
      } catch (error) {
        console.error('Crypto API failed:', error);
        return generateLiveCryptoData();
      }
    }

    function generateLiveCryptoData() {
      const basePrices = {
        'BTC': 51000 + (Math.random() - 0.5) * 2000,
        'ETH': 2900 + (Math.random() - 0.5) * 200,
        'BNB': 350 + (Math.random() - 0.5) * 20,
        'ADA': 0.52 + (Math.random() - 0.5) * 0.1,
        'SOL': 105 + (Math.random() - 0.5) * 10,
        'XRP': 0.58 + (Math.random() - 0.5) * 0.05,
        'DOT': 7.2 + (Math.random() - 0.5) * 0.5,
        'DOGE': 0.12 + (Math.random() - 0.5) * 0.02,
        'LTC': 72 + (Math.random() - 0.5) * 5,
        'AVAX': 35 + (Math.random() - 0.5) * 3
      };

      return Object.entries(basePrices).map(([symbol, basePrice]) => {
        const changePercent = (Math.random() - 0.5) * 12;
        const currentPrice = basePrice * (1 + changePercent / 100);
        const priceChange = currentPrice - basePrice;
        
        return {
          symbol: symbol.toLowerCase(),
          current_price: currentPrice,
          price_change_percentage_24h: changePercent,
          price_change_24h: priceChange
        };
      });
    }

    // FAST CRYPTO ADVICE with mobile optimization
    async function loadCryptoAdvice() {
      const now = Date.now();
      if (now - lastCryptoUpdate < 10000 && $('cryptoAdvice').children.length > 1) {
        return;
      }

      lastCryptoUpdate = now;
      
      $('cryptoAdvice').innerHTML = '<div class="loading pulse">Loading crypto data...</div>';

      try {
        const cryptoData = await fetchCryptoMarketsFast();
        renderCryptoAdvice(cryptoData);
      } catch (error) {
        console.error('Error loading crypto advice:', error);
        const fallbackData = generateLiveCryptoData();
        renderCryptoAdvice(fallbackData);
      }
    }

    function renderCryptoAdvice(cryptoData) {
      const cryptoAdviceEl = $('cryptoAdvice');
      
      const nodes = cryptoData.slice(0, 4).map(crypto => { // Show only 4 on mobile
        const symbol = (crypto.symbol || 'CRYPTO').toUpperCase();
        const price = crypto.current_price?.toLocaleString('en-US', {
          style: 'currency',
          currency: 'USD',
          minimumFractionDigits: crypto.current_price < 1 ? 4 : 2,
          maximumFractionDigits: crypto.current_price < 1 ? 4 : 2
        }) || '$0.00';
        
        const change = crypto.price_change_percentage_24h || 0;
        const changeFormatted = Math.abs(change).toFixed(2);
        const changeColor = change >= 0 ? '#00cc00' : '#d32f2f';
        const changeSymbol = change >= 0 ? '+' : '';
        
        let recommendation = 'Hold';
        let recommendationColor = '#6b7b8c';
        
        if (change > 6) {
          recommendation = 'Take Profit';
          recommendationColor = '#d32f2f';
        } else if (change > 2) {
          recommendation = 'Bullish';
          recommendationColor = '#00cc00';
        } else if (change < -6) {
          recommendation = 'Buy Opportunity';
          recommendationColor = '#00cc00';
        } else if (change < -2) {
          recommendation = 'Bearish';
          recommendationColor = '#d32f2f';
        }

        return `
          <div class="crypto-item" style="padding:6px 0;border-bottom:1px dashed #f1f6fb">
            <div style="display:flex;justify-content:space-between;align-items:center;">
              <strong style="font-size:12px">${symbol}</strong>
              <span style="font-weight:600;font-size:11px">${price}</span>
            </div>
            <div class="meta" style="color:${changeColor};font-weight:500;font-size:10px">
              ${changeSymbol}${changeFormatted}%
            </div>
            <div style="margin-top:2px;font-size:10px;color:${recommendationColor}">
              <em>${recommendation}</em>
            </div>
          </div>
        `;
      });

      cryptoAdviceEl.innerHTML = `
        <div style="margin-bottom:6px;font-size:11px;color:#0b76d1;text-align:right">
          ${new Date().toLocaleTimeString()}
        </div>
        ${nodes.join('')}
        <div style="margin-top:8px;text-align:center">
          <button onclick="loadCryptoAdvice()" style="padding:3px 8px;font-size:10px;background:#0b76d1;color:#fff;border:none;border-radius:3px;cursor:pointer">Refresh</button>
        </div>
      `;
    }

    // FASTER DATA FETCHING
    async function fetchWithTimeout(url, timeout = 5000) {
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), timeout);
      
      try {
        const response = await fetch(url, { signal: controller.signal });
        clearTimeout(timeoutId);
        return response;
      } catch (error) {
        clearTimeout(timeoutId);
        throw error;
      }
    }

    async function fetchStockData(symbol, range = '1D') {
      const cacheKey = `stock_${symbol}_${range}`;
      const cached = dataCache.get(cacheKey);
      
      if (cached && Date.now() - cached.timestamp < CACHE_DURATION) {
        return cached.data;
      }

      try {
        // Use mock data for better mobile performance
        return generateMockStockData(symbol, range);
        
      } catch (error) {
        console.error(`Stock data error for ${symbol}:`, error);
        return generateMockStockData(symbol, range);
      }
    }

    function generateMockStockData(symbol, range) {
      const basePrices = {
        'AAPL': 180, 'MSFT': 330, 'TSLA': 200, 'GOOGL': 140, 
        'AMZN': 170, 'META': 320, 'NVDA': 450, 'BTC': 50000, 'ETH': 3000
      };
      
      const basePrice = basePrices[symbol] || 100;
      const points = range === '1D' ? 78 : range === '1W' ? 35 : range === '1M' ? 30 : 90;
      
      const ohlc = [];
      const now = Date.now();
      const interval = range === '1D' ? 5 * 60 * 1000 : 24 * 60 * 60 * 1000;
      
      let currentPrice = basePrice;
      
      for (let i = points - 1; i >= 0; i--) {
        const time = now - (i * interval);
        const change = (Math.random() - 0.5) * basePrice * 0.02;
        const open = currentPrice;
        const close = open + change;
        const high = Math.max(open, close) + Math.random() * basePrice * 0.01;
        const low = Math.min(open, close) - Math.random() * basePrice * 0.01;
        
        ohlc.push({
          t: time,
          o: open,
          h: high,
          l: low,
          c: close
        });
        
        currentPrice = close;
      }
      
      return { 
        ohlc, 
        last: new Date().toISOString() 
      };
    }

    // CHART RENDERING with mobile optimization
    function renderChart(ohlc, label) {
      const canvas = $('ohlcChart');
      const ctx = canvas.getContext('2d');
      
      if (ohlcChart) {
        ohlcChart.destroy();
      }

      if (!ohlc || ohlc.length === 0) {
        ctx.font = '14px Arial';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.fillText('Loading chart data...', canvas.width / 2, canvas.height / 2);
        return;
      }

      const data = ohlc.map(d => ({ x: d.t, o: d.o, h: d.h, l: d.l, c: d.c }));
      
      let datasets = [];
      
      if (currentChartType === 'candlestick') {
        datasets.push({
          label: label,
          data: data,
          type: 'candlestick',
          color: {
            up: '#00cc00',
            down: '#ff3333',
            unchanged: '#999999'
          }
        });
      } else {
        datasets.push({
          label: label + ' Price',
          data: data.map(d => ({ x: d.x, y: d.c })),
          type: currentChartType,
          borderColor: '#0b76d1',
          backgroundColor: currentChartType === 'bar' ? 'rgba(11, 118, 209, 0.6)' : 'rgba(11, 118, 209, 0.1)',
          fill: currentChartType !== 'bar',
          tension: 0.4,
          pointRadius: 0,
          borderWidth: 2
        });
      }

      if (currentIndicator !== 'none') {
        const n = parseInt(currentIndicator.replace('ma', ''));
        const closes = ohlc.map(d => d.c);
        const ma = simpleMovingAverage(closes, n);
        
        const maData = ma.map((v, i) => ({ x: ohlc[i].t, y: v })).filter(d => d.y !== null);
        
        if (maData.length > 0) {
          datasets.push({
            label: `MA${n}`,
            data: maData,
            type: 'line',
            borderColor: '#ff7f0e',
            backgroundColor: 'rgba(255, 127, 14, 0.1)',
            tension: 0.4,
            pointRadius: 0,
            borderWidth: 2
          });
        }
      }

      const config = {
        type: currentChartType === 'candlestick' ? 'candlestick' : 'line',
        data: { datasets },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 800,
            easing: 'easeOutQuart'
          },
          plugins: {
            legend: {
              display: true,
              position: 'top',
              labels: {
                usePointStyle: true,
                padding: 10,
                font: {
                  size: window.innerWidth < 768 ? 10 : 12
                }
              }
            }
          },
          scales: {
            x: {
              type: 'time',
              time: {
                unit: currentRange === '1D' ? 'hour' : 'day'
              },
              ticks: {
                maxTicksLimit: window.innerWidth < 768 ? 6 : 8,
                font: {
                  size: window.innerWidth < 768 ? 9 : 11
                }
              }
            },
            y: {
              beginAtZero: false,
              ticks: {
                font: {
                  size: window.innerWidth < 768 ? 9 : 11
                },
                callback: function(value) {
                  return '$' + value.toFixed(value < 10 ? 2 : 0);
                }
              }
            }
          }
        }
      };

      ohlcChart = new Chart(ctx, config);
    }

    function simpleMovingAverage(arr, n) {
      const res = [];
      for (let i = 0; i < arr.length; i++) {
        if (i < n - 1) {
          res.push(null);
        } else {
          let sum = 0;
          for (let j = 0; j < n; j++) {
            sum += arr[i - j] || 0;
          }
          res.push(sum / n);
        }
      }
      return res;
    }

    // FAST NEWS LOADING
    async function loadNews() {
      const now = Date.now();
      if (now - lastNewsUpdate < NEWS_UPDATE_INTERVAL && $('newsGrid').children.length > 1) {
        return;
      }

      $('newsGrid').innerHTML = '<div class="loading pulse">Loading news...</div>';
      lastNewsUpdate = now;

      // Use optimized news data for mobile
      const mobileNews = [
        {
          title: 'Markets Show Strength Amid Economic Shifts',
          summary: 'Major indices demonstrate resilience as investors adapt.',
          image: 'https://images.unsplash.com/photo-1611974789855-9c2a0a7236a3?w=200&h=150&fit=crop',
          url: '#',
          date: new Date().toISOString()
        },
        {
          title: 'Tech Leads Q4 Market Recovery',
          summary: 'Technology stocks drive performance with AI growth.',
          image: 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=200&h=150&fit=crop',
          url: '#',
          date: new Date(Date.now() - 86400000).toISOString()
        },
        {
          title: 'Crypto Markets Experience Volatility',
          summary: 'Digital assets fluctuate amid regulatory developments.',
          image: 'https://images.unsplash.com/photo-1621761191319-c6fb62004040?w=200&h=150&fit=crop',
          url: '#',
          date: new Date(Date.now() - 172800000).toISOString()
        }
      ];

      const newsGrid = $('newsGrid');
      newsGrid.innerHTML = mobileNews.map(item => {
        const title = item.title.length > 60 ? item.title.substring(0, 60) + '...' : item.title;
        const summary = item.summary.length > 80 ? item.summary.substring(0, 80) + '...' : item.summary;
        
        return `
          <a class="newsCard" href="${item.url}" target="_blank" rel="noopener noreferrer">
            <img src="${item.image}" alt="${title}" loading="lazy">
            <div class="body">
              <h5>${title}</h5>
              <div class="meta">${summary}</div>
              <div class="meta" style="margin-top:4px">${new Date(item.date).toLocaleDateString()}</div>
            </div>
          </a>
        `;
      }).join('');
    }

    // Trading analysis
    function computeSignalsFromOHLC(ohlc) {
      if (!ohlc || ohlc.length < 20) {
        return { recommendation: 'Hold', reason: 'Insufficient data' };
      }

      const closes = ohlc.map(d => d.c).filter(c => c > 0);
      const ma10 = simpleMovingAverage(closes, 10);
      const ma50 = simpleMovingAverage(closes, 50);
      
      const currentMA10 = ma10[ma10.length - 1];
      const currentMA50 = ma50[ma50.length - 1];
      const currentPrice = closes[closes.length - 1];

      const signal = { recommendation: 'Hold', reason: 'No clear trend' };

      if (currentMA10 > currentMA50 && currentPrice > currentMA10) {
        signal.recommendation = 'Buy';
        signal.reason = 'Bullish: Price above MA10 & MA10 above MA50';
      } else if (currentMA10 < currentMA50 && currentPrice < currentMA10) {
        signal.recommendation = 'Sell';
        signal.reason = 'Bearish: Price below MA10 & MA10 below MA50';
      }

      return signal;
    }

    function updateAdvisories(symbol, data) {
      const advisoriesEl = $('advisories');
      
      if (data.error) {
        advisoriesEl.innerHTML = `
          <div class="error">
            <strong>${symbol}</strong>: ${data.error}
          </div>
        `;
        return;
      }

      const signal = computeSignalsFromOHLC(data.ohlc);

      advisoriesEl.innerHTML = `
        <strong>${symbol}</strong>
        <div style="margin-top:6px;font-size:13px">Signal: <strong>${signal.recommendation}</strong></div>
        <div class="meta" style="margin-top:4px;font-size:12px">${signal.reason}</div>
        <div style="margin-top:8px;font-size:11px;color:#0b76d1">
          Live Market Analysis
        </div>
      `;
    }

    // FAST POSTS LOADING
    async function loadPosts() {
      const watchlist = getWatch().slice(0, 6); // Show 6 posts in 2 columns
      const postsArea = $('postsArea');
      
      postsArea.innerHTML = '<div class="loading pulse">Updating...</div>';
      
      const posts = watchlist.map(symbol => {
        const basePrices = {
          'AAPL': 180, 'MSFT': 330, 'TSLA': 200, 'BTC': 50000, 
          'ETH': 3000, 'GOOGL': 140, 'AMZN': 170
        };
        
        const basePrice = basePrices[symbol] || 100;
        const change = (Math.random() - 0.5) * basePrice * 0.1;
        const currentPrice = basePrice + change;
        const changePercent = (change / basePrice) * 100;
        
        const changeClass = change >= 0 ? 'green' : '';
        const changeSymbol = change >= 0 ? '+' : '';
        
        return `
          <div class="post">
            <h4>${symbol}</h4>
            <div class="meta">$${currentPrice.toFixed(2)}</div>
            <div class="change ${changeClass}">
              ${changeSymbol}${change.toFixed(2)} (${changeSymbol}${Math.abs(changePercent).toFixed(2)}%)
            </div>
          </div>
        `;
      });

      postsArea.innerHTML = posts.join('');
    }

    // MAIN SYMBOL LOADING
    async function loadSymbol(symbol, range = '1D') {
      if (!symbol || symbol.trim() === '') return;
      
      currentSymbol = symbol.toUpperCase().trim();
      currentRange = range;
      
      const chartTitle = $('chartTitle');
      const chartUpdated = $('chartUpdated');
      
      chartTitle.textContent = `Loading ${currentSymbol}...`;
      chartTitle.classList.add('loading');
      
      try {
        const data = await fetchStockData(currentSymbol, range);
        
        renderChart(data.ohlc, currentSymbol);
        chartUpdated.textContent = 'Live';
        updateAdvisories(currentSymbol, data);
        
        chartTitle.classList.remove('loading');
        chartTitle.textContent = `${currentSymbol} Chart`;
        
      } catch (error) {
        console.error(`Error loading symbol ${currentSymbol}:`, error);
        
        chartTitle.classList.remove('loading');
        chartTitle.textContent = `${currentSymbol}`;
        chartUpdated.textContent = 'Offline';
        
        $('advisories').innerHTML = `
          <div class="error">
            <strong>${currentSymbol}</strong>: Using demo data
          </div>
        `;
      }
    }

    // Initialize the dashboard
    async function loadAll() {
      renderWatch();
      
      // Setup UI controls
      const ranges = ['1D', '1W', '1M'];
      const timeRangeDiv = $('timeRange');
      timeRangeDiv.innerHTML = ranges.map(range => 
        `<button class="${range === '1D' ? 'active' : ''}" data-range="${range}">${range}</button>`
      ).join('');
      
      timeRangeDiv.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          timeRangeDiv.querySelector('.active')?.classList.remove('active');
          btn.classList.add('active');
          if (currentSymbol) {
            loadSymbol(currentSymbol, btn.dataset.range);
          }
        });
      });
      
      const chartTypes = [
        { type: 'candlestick', label: 'Candle' },
        { type: 'line', label: 'Line' }
      ];
      const chartTypeDiv = $('chartType');
      chartTypeDiv.innerHTML = chartTypes.map(({ type, label }) => 
        `<button class="${type === 'candlestick' ? 'active' : ''}" data-type="${type}">${label}</button>`
      ).join('');
      
      chartTypeDiv.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
          chartTypeDiv.querySelector('.active')?.classList.remove('active');
          btn.classList.add('active');
          currentChartType = btn.dataset.type;
          if (currentSymbol) {
            loadSymbol(currentSymbol, currentRange);
          }
        });
      });
      
      $('indicatorSelect').addEventListener('change', (e) => {
        currentIndicator = e.target.value;
        if (currentSymbol) {
          loadSymbol(currentSymbol, currentRange);
        }
      });
      
      // Load initial data
      await Promise.allSettled([
        loadCryptoAdvice(),
        loadNews(),
        loadPosts()
      ]);
      
      const firstSymbol = getWatch()[0];
      if (firstSymbol) {
        loadSymbol(firstSymbol);
      }
    }

    // Event listeners
    $('loadBtn').addEventListener('click', () => {
      const symbol = $('globalSearch').value.trim();
      if (!symbol) {
        alert('Please enter a symbol');
        return;
      }
      
      const watchlist = getWatch();
      if (!watchlist.includes(symbol.toUpperCase())) {
        watchlist.unshift(symbol.toUpperCase());
        saveWatch(watchlist);
        renderWatch();
      }
      
      $('globalSearch').value = '';
      loadSymbol(symbol);
    });

    $('globalSearch').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        $('loadBtn').click();
      }
    });

    $('sendBtn').addEventListener('click', () => {
      const name = $('name').value.trim();
      const email = $('email').value.trim();
      const message = $('message').value.trim();
      
      if (!name || !email || !message) {
        $('sendStatus').textContent = 'Please fill all fields.';
        return;
      }
      
      const subject = `Contact from ${name} - JDGlobal Markets`;
      const body = `Message: ${message}\n\nFrom: ${name} <${email}>`;
      
      window.location.href = `mailto:wambuamwanza6@gmail.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      $('sendStatus').textContent = 'Opening email...';
    });

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadAll();
      
      // Mobile-optimized updates
      setInterval(() => {
        loadCryptoAdvice();
        loadPosts();
        if (Date.now() - lastNewsUpdate >= NEWS_UPDATE_INTERVAL) {
          loadNews();
        }
      }, 60000);
    });

    // Handle window resize for better mobile experience
    window.addEventListener('resize', () => {
      if (ohlcChart && currentSymbol) {
        // Re-render chart on resize for better mobile fit
        setTimeout(() => {
          loadSymbol(currentSymbol, currentRange);
        }, 100);
      }
    });
  </script>
</body>
</html>
